<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta property="qc:admins" content="2336345717671415156375"/>
    <title></title>
    <script src="http://www.gilieye.com/js/vendor/av.js"></script>
    <script src="js/lib/gili_api.js"></script>
    <script src="https://code.jquery.com/jquery-3.0.0.min.js"></script>
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {
            //实例化AV
            AV.initialize("oCjYs9w05WuNmCk6sDblt7hY-gzGzoHsz", "yaREoDyiyoy5iWV2iWAODk5X");
            var code = getParam(location.href, "code");
            console.log(code);
            var _url = "https://api.weibo.com/oauth2/access_token?client_id=2720439896&client_secret=49df09be0f1fc7e4ef082a23ac385e97&grant_type=authorization_code&redirect_uri=http://www.gilieye.com/test.html&code=" + code;
            $.get(_url, function(data){
                console.log(data);
            });
        });

        /**
         * 获取url参数值
         *
         * @params url {string} url
         * @params param {string} 参数名
         * @return {string}
         */
        function getParam(url, param) {
            var iLen = param.length;
            var iStart = url.indexOf(param);
            if (iStart == -1) {
                return "";
            }
            iStart += iLen + 1;
            var iEnd = url.indexOf("&", iStart);
            if (iEnd == -1) {
                return url.substring(iStart);
            }
            return url.substring(iStart, iEnd);
        }

        /**
         * 获取Token
         */
        function getTokenParam() {
        }

        function loginuser(data) {
            var unionid = data.unionid;
            var nickname = data.nickname;
            var sexual = data.sexual;
            var headimgurl = data.headimgurl;
            //检索对象
            var User = AV.Object.extend("_User");
            var query = new AV.Query(User);
            query.equalTo("username", unionid);
            query.find({
                success: function (user) {
                    if (user.length > 0) {
                        //用户存在则登陆绑定
                        AV.User.logIn(unionid, "6a063e705a16e625", {
                            success: function (_user) {
                                window.location.href = 'http://www.gilieye.com';
                            },
                            error: function (_user, error) {
                                console.log(error.message);
                            }
                        })
                    } else {
                        //用户不存在则注册
                        var user = new AV.User();
                        user.set("username", unionid);
                        user.set("password", "6a063e705a16e625"); //me第三方登录
                        user.set('user_nick', nickname);
                        user.set("avatar", headimgurl);
                        user.set("sex", sexual);
                        gili_data.signUp(user, function (user) {
                            //注册成功则登陆
                            AV.User.logIn(unionid, "6a063e705a16e625", {
                                success: function (user) {
                                    window.location.href = 'http://www.gilieye.com';
                                },
                                error: function (user, error) {
                                    console.log(error.message);
                                }
                            })
                        },function (user, error) {
                            console.log(error.message);
                        });
                    }
                },
                error: function (error) {
                    console.log(error.message);
                }
            });
        }
    </script>

</head>
<body>


</body>
</html>